<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Web App ‚Äì Material 0301</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap');

    :root {
      --primary: #2563eb;
      --primary-soft: #e0edff;
      --bg: #f3f4f8;
      --card-bg: #ffffff;
      --border-soft: #e2e8f0;
      --text-main: #111827;
      --text-muted: #6b7280;
      --tab-bg: #ffffff;
      --tab-active: #2563eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans Thai', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at top, #e0ebff 0, #f3f4f8 45%, #f9fafb 100%);
      color: var(--text-main);
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
    }

    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    header.app-header .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    header.app-header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    header.app-header .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.08);
      color: var(--primary);
      font-size: 0.75rem;
      font-weight: 600;
      gap: 6px;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.9);
      padding: 4px;
      border-radius: 999px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      border: 1px solid rgba(148, 163, 184, 0.3);
      margin-bottom: 16px;
      width: fit-content;
    }

    .tab-btn {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease;
    }

    .tab-btn span.icon {
      font-size: 1rem;
    }

    .tab-btn.active {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Cards & table (Barcode tab) */
    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 16px 20px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.04);
      border: 1px solid var(--border-soft);
      margin-bottom: 16px;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .status {
      font-size: 0.8rem;
      margin-top: 6px;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(to right, #2563eb, #1d4ed8);
      color: #fff;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      font-weight: 600;
      white-space: nowrap;
    }

    td input {
      width: 100%;
      box-sizing: border-box;
      border: none;
      padding: 4px 6px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    td input[readonly] {
      background: #f3f4f6;
      color: #4b5563;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .not-found {
      color: #dc2626;
      font-size: 0.8rem;
    }

    #empCodeInput {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      min-width: 220px;
      margin-left: 4px;
      font-size: 0.9rem;
    }

    #empCodeInput:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
    }

    .employee-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 6px;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .print-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--primary);
      background: #ffffff;
      cursor: pointer;
      margin-left: 6px;
      font-size: 0.9rem;
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.15);
      transition: all 0.18s ease;
    }

    .print-btn:hover {
      background: var(--primary);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25);
    }

    .print-btn .emoji {
      font-size: 1rem;
    }

    /* ========= ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏â‡∏•‡∏≤‡∏Å Small 102x30 mm ========= */
    #printArea {
      display: none;
    }
    .container-small {
      display: block;
      width: 106mm;
    }
    .sticker-small {
      width: 106mm;
      height: 30mm;
      display: flex;
      flex-direction: row;
      background: white;
      box-sizing: border-box;
      margin-bottom: 0;
    }
    .label-small {
      width: 53mm;
      height: 30mm;
      box-sizing: border-box;
      padding: 1mm;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-right: 0.5px solid #ccc;
    }
    .label-small:last-child {
      border-right: none;
    }
    .row-small {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-bottom: 1mm;
    }
    .qr-small {
      width: 10mm;
      height: 10mm;
      margin-right: 5mm;
      margin-left: 3mm;
    }
    .material-small {
      font-size: 24px;
      font-weight: bold;
      text-align: left;
      margin: 0;
      line-height: 1;
    }
    .technician-small {
      font-size: 10px;
      text-align: left;
      margin: 0;
      margin-right: 2mm;
      line-height: 1;
    }
    .department-small {
      font-size: 10px;
      text-align: left;
      margin: 0;
      margin-right: 2mm;
      line-height: 1;
    }
    .description-small {
      font-size: 10px;
      font-weight: bold;
      text-align: left;
      line-height: 1.2;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      word-wrap: break-word;
      margin: 0;
      margin-left: 2mm;
    }
    .location-small {
      font-size: 12px;
      font-weight: bold;
      text-align: left;
      margin-top: 1px;
      margin-bottom: 0;
      line-height: 1.1;
      margin-left: 2mm;
    }
    .lot-line-small {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 0;
      line-height: 1.1;
      margin-left: 2mm;
      margin-right: 1mm;
    }
    .barcode-small {
      margin-left: 2mm;
      width: 15mm !important;
      height: 6mm !important;
    }

    /* ========= ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏â‡∏•‡∏≤‡∏Å Big 80x100 mm ========= */
    .container-big {
      display: block;
      width: 80mm;
    }
    .sticker-big {
      width: 80mm;
      height: 100mm;
      display: flex;
      flex-direction: column;
      background: white;
      box-sizing: border-box;
      margin-bottom: 0;
      position: relative;
    }
    .label-big {
      width: 80mm;
      height: 100mm;
      box-sizing: border-box;
      padding: 2mm;
      padding-bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 0;
      position: relative;
    }
    .row-big {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      align-items: flex-start;
      margin-bottom: 2mm;
    }
    .bottom-container-big {
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .qr-big {
      width: 20mm;
      height: 20mm;
      margin-right: 2mm;
      margin-left: 3mm;
    }
    .text-container-big {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 50mm;
    }
    .material-big {
      font-size: 40px;
      font-weight: bold;
      text-align: left;
      margin: 0;
      line-height: 1.1;
    }
    .technician-big {
      font-size: 16px;
      text-align: left;
      margin: 0;
      line-height: 1.3;
    }
    .department-big {
      font-size: 16px;
      text-align: left;
      margin: 0;
      line-height: 1.3;
    }
    .description-big {
      font-size: 20px;
      font-weight: bold;
      text-align: left;
      line-height: 1.3;
      width: calc(100% - 4mm);
      margin: 2mm 0 0 3mm;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      word-wrap: break-word;
    }
    .location-big {
      font-size: 25px;
      font-weight: bold;
      text-align: left;
      margin-top: 0;
      margin-bottom: 0;
      line-height: 1.3;
      margin-left: 3mm;
    }
    .lot-line-big {
      font-size: 20px;
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 0;
      line-height: 1.3;
      margin-left: 3mm;
      margin-right: 2mm;
    }
    .center-pack-unit-big {
      position: absolute;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -30%);
      font-size: 60px;
      font-weight: bold;
      text-align: center;
      width: 80%;
      margin: 0;
      padding: 0;
      line-height: 1;
    }

    /* Spinner */
    .spinner-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    #spinner { display: none; }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media print {
      header.app-header,
      .tabs,
      .print-btn,
      .spinner-container,
      #appRoot {
        display: none !important;
      }

      #printArea {
        display: block !important;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: 'Noto Sans Thai', sans-serif;
        background: #ffffff;
      }

      .sticker-small,
      .sticker-big {
        page-break-inside: avoid;
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="title-block">
        <h1>Web App ‚Äì Material 0301</h1>
        <div class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏â‡∏•‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏ö‡∏ö Small / Big</div>
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        <span>‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: Barcode</span>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="barcode">
        <span class="icon">üè∑Ô∏è</span>
        <span>Barcode</span>
      </button>
      <button class="tab-btn" data-tab="serial">
        <span class="icon">#Ô∏è‚É£</span>
        <span>Serial Number</span>
      </button>
    </div>

    <!-- Tab: Barcode -->
    <div id="tab-barcode" class="tab-panel active">
      <div id="appRoot">
        <!-- Card: ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á + ‡∏õ‡∏∏‡πà‡∏° Print + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
        <div class="card">
          <div class="card-header-row">
            <div class="card-title">
              <span>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ Barcode</span>
              <span class="card-title-pill">Small & Big Label</span>
            </div>
            <div>
              <button id="printSmallBtn" class="print-btn">
                <span class="emoji">üñ®Ô∏è</span> Print Small
              </button>
              <button id="printBigBtn" class="print-btn">
                <span class="emoji">üñ®Ô∏è</span> Print Big
              </button>
            </div>
          </div>
          <div class="status" id="dataStatus"></div>
        </div>

        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
        <div class="card">
          <div class="card-title">
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
          </div>
          <div class="employee-row">
            <label>
              ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:
              <input id="empCodeInput" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter" />
            </label>
          </div>
          <div class="status" id="empStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</div>
        </div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
        <div class="card">
          <div class="card-title">
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Material
          </div>
          <table id="entryTable">
            <thead>
              <tr>
                <th style="width:60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th style="width:140px;">Material</th>
                <th>Description</th>
                <th style="width:140px;">Storage bin</th>
                <th style="width:120px;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                <th style="width:100px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                <th style="width:120px;">Pack</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="status" id="rowStatus"></div>
        </div>
      </div>

      <!-- Spinner -->
      <div class="spinner-container" id="spinner">
        <div class="spinner"></div>
      </div>

      <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å -->
      <div id="printArea"></div>
    </div>

    <!-- Tab: Serial Number (‡∏ß‡πà‡∏≤‡∏á ‡πÜ ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô) -->
    <div id="tab-serial" class="tab-panel">
      <div class="card">
        <div class="card-title">
          Serial Number
          <span class="card-title-pill">Coming soon</span>
        </div>
        <div class="status" style="margin-top:10px;">
          ‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Serial Number ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
        </div>
      </div>
    </div>
  </div>

  <!-- QRCode & Barcode libs -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <script>
    // ==== ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö ====
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabPanels  = {
      barcode: document.getElementById('tab-barcode'),
      serial:  document.getElementById('tab-serial')
    };

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-tab');

        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        Object.keys(tabPanels).forEach(key => {
          tabPanels[key].classList.toggle('active', key === target);
        });
      });
    });

    // ==== ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ====

    const DATA_URL_0301 = 'https://opensheet.elk.sh/1x-B1xekpMm4p7fkKucvLjaewtp66uGIp8ZIxJJZAxMk/Sheet1';
    const EMP_URL       = 'https://opensheet.elk.sh/1eqVoLsZxGguEbRCC5rdI4iMVtQ7CK4T3uXRdx8zE3uw/Employee';

    let materialDB = [];
    let employeeDB = [];
    let nextIndex = 1;

    const dataStatusEl = document.getElementById('dataStatus');
    const rowStatusEl  = document.getElementById('rowStatus');
    const tableBody    = document.querySelector('#entryTable tbody');

    const empCodeInput = document.getElementById('empCodeInput');
    const empStatus    = document.getElementById('empStatus');
    const spinner      = document.getElementById('spinner');

    let employeeCode = '';
    let employeeName = '';
    let employeeTeam = '';

    async function loadMaterialData() {
      try {
        const res = await fetch(DATA_URL_0301);
        const data = await res.json();
        materialDB = data;
        if (dataStatusEl) {
          dataStatusEl.textContent = `‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 0301 ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${materialDB.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
        }
      } catch (err) {
        console.error(err);
        if (dataStatusEl) {
          dataStatusEl.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 0301 ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
        }
      }
    }

    async function loadEmployeeData() {
      try {
        const res = await fetch(EMP_URL);
        const data = await res.json();
        employeeDB = data;
        empStatus.textContent = `‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${employeeDB.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
      } catch (err) {
        console.error(err);
        empStatus.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
      }
    }

    function normalizeMaterialCode(raw) {
      if (!raw) return '';
      const trimmed = String(raw).trim();
      const len = trimmed.length;

      if (len === 3)  return '30000' + trimmed;
      if (len === 4)  return '3000'  + trimmed;
      if (len === 5)  return '300'   + trimmed;
      return trimmed;
    }

    function findMaterialInfo(materialCode) {
      if (!materialCode) return null;

      const m = materialDB.find(row => {
        const mat = row.Material || row.MATERIAL || row.material || row['Material Code'];
        return mat && String(mat).trim() === String(materialCode).trim();
      });

      if (!m) return null;

      const description =
        m['Material description'] ||
        m['material description'] ||
        m['MATERIAL DESCRIPTION'] ||
        '';

      const storageBin =
        m['Storage bin'] ||
        m['STORAGE BIN'] ||
        m.StorageBin ||
        m['Storage Bin'] ||
        '';

      const unrestricted =
        m['Unrestricted'] ||
        m['unrestricted'] ||
        m['UNRESTRICTED'] ||
        m['Unrestrict'] ||
        '';

      return { description, storageBin, unrestricted };
    }

    function findEmployeeById(id) {
      if (!id) return null;
      const trimmed = String(id).trim();

      return employeeDB.find(row => {
        const rec = row.IDRec || row.idrec || row.Id || row.ID;
        return rec && String(rec).trim() === trimmed;
      });
    }

    function fillRowByMaterial(tr) {
      const inputs = tr.querySelectorAll('input');
      const [inputMat, inputDesc, inputBin, inputRemain, inputQty, inputPack] = inputs;

      let matValue = inputMat.value.trim();
      if (!matValue) {
        rowStatusEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Material';
        return false;
      }

      const normalized = normalizeMaterialCode(matValue);
      inputMat.value = normalized;

      const info = findMaterialInfo(normalized);

      if (!info || !info.description) {
        inputDesc.value   = '';
        inputBin.value    = '';
        inputRemain.value = '';
        rowStatusEl.innerHTML =
          `<span class="not-found">‡πÑ‡∏°‡πà‡∏û‡∏ö Material ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ Description: ${normalized} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà</span>`;
        inputMat.value = '';
        inputMat.focus();
        return false;
      }

      inputDesc.value   = info.description || '';
      inputBin.value    = info.storageBin || '';
      inputRemain.value = info.unrestricted || '';

      rowStatusEl.textContent = `‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Material ${normalized} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
      return true;
    }

    function addNewRow() {
      const tr = document.createElement('tr');

      const tdIndex = document.createElement('td');
      tdIndex.textContent = nextIndex;
      tr.appendChild(tdIndex);

      const tdMat = document.createElement('td');
      const inputMat = document.createElement('input');
      inputMat.type = 'text';
      inputMat.placeholder = '‡∏Å‡∏£‡∏≠‡∏Å Material ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î';
      tdMat.appendChild(inputMat);
      tr.appendChild(tdMat);

      const tdDesc = document.createElement('td');
      const inputDesc = document.createElement('input');
      inputDesc.type = 'text';
      inputDesc.readOnly = true;
      tdDesc.appendChild(inputDesc);
      tr.appendChild(tdDesc);

      const tdBin = document.createElement('td');
      const inputBin = document.createElement('input');
      inputBin.type = 'text';
      inputBin.readOnly = true;
      tdBin.appendChild(inputBin);
      tr.appendChild(tdBin);

      const tdRemain = document.createElement('td');
      const inputRemain = document.createElement('input');
      inputRemain.type = 'text';
      inputRemain.readOnly = true;
      tdRemain.appendChild(inputRemain);
      tr.appendChild(tdRemain);

      const tdQty = document.createElement('td');
      const inputQty = document.createElement('input');
      inputQty.type = 'number';
      inputQty.min = '1';
      inputQty.placeholder = '1';
      inputQty.value = 1;
      tdQty.appendChild(inputQty);
      tr.appendChild(tdQty);

      const tdPack = document.createElement('td');
      const inputPack = document.createElement('input');
      inputPack.type = 'number';
      inputPack.min = '1';
      inputPack.placeholder = '1';
      inputPack.value = 1;
      tdPack.appendChild(inputPack);
      tr.appendChild(tdPack);

      inputMat.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const ok = fillRowByMaterial(tr);
          if (ok) {
            inputQty.focus();
            inputQty.select();
          }
        }
      });

      inputQty.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (!inputMat.value.trim() || !inputDesc.value.trim()) {
            rowStatusEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Material ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô';
            inputMat.focus();
            return;
          }
          nextIndex++;
          addNewRow();
        }
      });

      tableBody.appendChild(tr);
      inputMat.focus();
    }

    // ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Üí ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠/‡∏ó‡∏µ‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ + focus ‡∏ó‡∏µ‡πà Material ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ö
if (empCodeInput) {
  empCodeInput.addEventListener('input', () => {
    const code = empCodeInput.value.trim();
    employeeCode = code;

    // ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
    if (!code) {
      empStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
      employeeName = '';
      employeeTeam = '';
      return;
    }

    // ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏µ‡∏ö‡∏Ñ‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ï‡∏±‡∏ß‡∏Å‡πà‡∏≠‡∏ô)
    if (code.length < 7) {
      empStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...';
      employeeName = '';
      employeeTeam = '';
      return;
    }

    const emp = findEmployeeById(code);
    if (!emp) {
      empStatus.innerHTML =
        `<span class="not-found">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${code}</span>`;
      employeeName = '';
      employeeTeam = '';
      return;
    }

    const name = emp.Name || emp.NAME || emp['Employee Name'] || '';
    const team = emp.Team || emp.TEAM || emp['Team Name'] || '';
    employeeName = name;
    employeeTeam = team;
    empStatus.textContent =
      `‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${code} : ${name} (${team})`;

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏´‡πâ cursor ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Material ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
    const firstMat = document.querySelector('#entryTable tbody tr:first-child input');
    if (firstMat) {
      firstMat.focus();
      firstMat.select();
    }
  });
}

    function collectPrintData() {
      const rows = Array.from(tableBody.querySelectorAll('tr'));
      const data = [];

      rows.forEach(tr => {
        const inputs = tr.querySelectorAll('input');
        if (inputs.length < 6) return;

        const [inputMat, inputDesc, inputBin, inputRemain, inputQty, inputPack] = inputs;
        const material = inputMat.value.trim();
        if (!material) return;

        const qty = parseInt(inputQty.value, 10) || 1;

        data.push({
          Material:   material,
          ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:      qty,
          Pack:       inputPack.value || '',
          ID‡∏ä‡πà‡∏≤‡∏á:     employeeCode || '',
          Serial:     '-',
          Description:inputDesc.value || '',
          Storagebin: inputBin.value || '',
          ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á:   employeeName || '',
          Unit:       'pc',
          ‡πÅ‡∏ú‡∏ô‡∏Å:       employeeTeam || ''
        });
      });

      return data;
    }

    // Small label
    function createPrintLabelSmall(row) {
      const label = document.createElement('div');
      label.className = 'label-small';

      const rowDiv = document.createElement('div');
      rowDiv.className = 'row-small';

      const qrCanvas = document.createElement('canvas');
      qrCanvas.className = 'qr-small';
      rowDiv.appendChild(qrCanvas);

      const textContainer = document.createElement('div');
      textContainer.style.display = 'flex';
      textContainer.style.flexDirection = 'column';

      const materialDiv = document.createElement('div');
      materialDiv.className = 'material-small';
      materialDiv.textContent = row.Material;
      textContainer.appendChild(materialDiv);

      const techNameRaw = row.‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á || '';
      const technicianName = techNameRaw.replace(/^‡∏ô‡∏≤‡∏¢\s+/, '').trim();
      if (technicianName) {
        const technicianDiv = document.createElement('div');
        technicianDiv.className = 'technician-small';
        technicianDiv.textContent = technicianName;
        textContainer.appendChild(technicianDiv);
      }

      const dept = (row.‡πÅ‡∏ú‡∏ô‡∏Å || '').trim();
      if (dept) {
        const departmentDiv = document.createElement('div');
        departmentDiv.className = 'department-small';
        departmentDiv.textContent = dept;
        textContainer.appendChild(departmentDiv);
      }

      rowDiv.appendChild(textContainer);
      label.appendChild(rowDiv);

      const descText = (row.Description || '').trim();
      if (descText) {
        const desc = document.createElement('div');
        desc.className = 'description-small';
        desc.textContent = descText;
        label.appendChild(desc);
      }

      const locLine = document.createElement('div');
      locLine.style.display = 'flex';
      locLine.style.alignItems = 'center';
      locLine.style.fontSize = '12px';
      locLine.style.fontWeight = 'bold';
      locLine.style.lineHeight = '1.1';
      locLine.style.marginLeft = '2mm';
      locLine.style.marginTop = '1px';
      locLine.style.marginBottom = '0';

      const locTextStr = (row.Storagebin || '').trim();
      if (locTextStr) {
        const locText = document.createElement('span');
        locText.textContent = `Loc: ${locTextStr}`;
        locLine.appendChild(locText);
      }

      const barcodeCanvas = document.createElement('canvas');
      barcodeCanvas.className = 'barcode-small';
      locLine.appendChild(barcodeCanvas);
      label.appendChild(locLine);

      const now = new Date();
      const formattedDate =
        `${now.getFullYear().toString().slice(2)}` +
        `${String(now.getMonth() + 1).padStart(2, '0')}` +
        `${String(now.getDate()).padStart(2, '0')}` +
        `${String(now.getHours()).padStart(2, '0')}` +
        `${String(now.getMinutes()).padStart(2, '0')}`;

      const lot = document.createElement('div');
      lot.className = 'lot-line-small';

      const parts = [];
      parts.push(`Lot: ${formattedDate}`);
      const qtyText  = row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ? `(${row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô})` : '';
      if (qtyText) parts.push(qtyText);
      const packText = (row.Pack || '').trim();
      if (packText) parts.push(packText);
      const unitText = (row.Unit || '').trim();
      if (unitText) parts.push(unitText);

      lot.innerHTML = `<span>${parts.join(' ')}</span>`;
      label.appendChild(lot);

      if (typeof QRCode !== 'undefined') {
        QRCode.toCanvas(qrCanvas, row.Material || 'N/A', {
          width: 40,
          height: 40,
          margin: 0,
          errorCorrectionLevel: 'L'
        }, err => { if (err) console.error('QR Error:', err); });
      }

      if (typeof JsBarcode !== 'undefined' && row.Material) {
        JsBarcode(barcodeCanvas, row.Material, {
          format: 'CODE128',
          width: 1,
          height: 15,
          displayValue: false,
          margin: 0
        });
      }

      return label;
    }

    function buildPrintLabelsSmall(data) {
      const printArea = document.getElementById('printArea');
      printArea.innerHTML = '';

      const container = document.createElement('div');
      container.className = 'container-small';
      printArea.appendChild(container);

      const expanded = [];
      data.forEach(row => {
        const qty = Math.max(1, row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô);
        for (let i = 0; i < qty; i++) {
          expanded.push({ ...row });
        }
      });

      for (let i = 0; i < expanded.length; i += 2) {
        const sticker = document.createElement('div');
        sticker.className = 'sticker-small';

        const label1 = createPrintLabelSmall(expanded[i]);
        sticker.appendChild(label1);

        if (i + 1 < expanded.length) {
          const label2 = createPrintLabelSmall(expanded[i + 1]);
          sticker.appendChild(label2);
        } else {
          const emptyLabel = document.createElement('div');
          emptyLabel.className = 'label-small';
          const emptyDiv = document.createElement('div');
          emptyDiv.className = 'description-small';
          emptyDiv.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          emptyLabel.appendChild(emptyDiv);
          sticker.appendChild(emptyLabel);
        }

        container.appendChild(sticker);
      }
    }

    // Big label
    function createPrintLabelBig(row) {
      const label = document.createElement('div');
      label.className = 'label-big';

      const rowDiv = document.createElement('div');
      rowDiv.className = 'row-big';

      const qrCanvas = document.createElement('canvas');
      qrCanvas.className = 'qr-big';
      rowDiv.appendChild(qrCanvas);

      const textContainer = document.createElement('div');
      textContainer.className = 'text-container-big';

      const materialDiv = document.createElement('div');
      materialDiv.className = 'material-big';
      materialDiv.textContent = row.Material;
      textContainer.appendChild(materialDiv);

      const techNameRaw = row.‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á || '';
      const technicianName = techNameRaw.replace(/^‡∏ô‡∏≤‡∏¢\s+/, '').trim();
      if (technicianName) {
        const technicianDiv = document.createElement('div');
        technicianDiv.className = 'technician-big';
        technicianDiv.textContent = technicianName;
        textContainer.appendChild(technicianDiv);
      }

      const dept = (row.‡πÅ‡∏ú‡∏ô‡∏Å || '').trim();
      if (dept) {
        const departmentDiv = document.createElement('div');
        departmentDiv.className = 'department-big';
        departmentDiv.textContent = dept;
        textContainer.appendChild(departmentDiv);
      }

      rowDiv.appendChild(textContainer);

      const descText = (row.Description || '').trim();
      if (descText) {
        const desc = document.createElement('div');
        desc.className = 'description-big';
        desc.textContent = descText;
        rowDiv.appendChild(desc);
      }

      label.appendChild(rowDiv);

      const bottomContainer = document.createElement('div');
      bottomContainer.className = 'bottom-container-big';

      const now = new Date();
      const formattedDate =
        `${now.getFullYear().toString().slice(2)}` +
        `${String(now.getMonth() + 1).padStart(2, '0')}` +
        `${String(now.getDate()).padStart(2, '0')}` +
        `${String(now.getHours()).padStart(2, '0')}` +
        `${String(now.getMinutes()).padStart(2, '0')}`;

      const locTextStr = (row.Storagebin || '').trim();
      if (locTextStr) {
        const loc = document.createElement('div');
        loc.className = 'location-big';
        loc.textContent = `Location: ${locTextStr}`;
        bottomContainer.appendChild(loc);
      }

      const lot = document.createElement('div');
      lot.className = 'lot-line-big';
      lot.textContent = `Lot: ${formattedDate} Qty(${row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô || 1})`;
      bottomContainer.appendChild(lot);

      label.appendChild(bottomContainer);

      const centerPackUnit = document.createElement('div');
      centerPackUnit.className = 'center-pack-unit-big';
      const packText = (row.Pack || '').trim();
      const unitText = (row.Unit || '').trim();
      centerPackUnit.textContent = `${packText} ${unitText}`.trim();
      label.appendChild(centerPackUnit);

      if (typeof QRCode !== 'undefined') {
        QRCode.toCanvas(qrCanvas, row.Material || 'N/A', {
          width: 75,
          height: 75,
          margin: 0,
          errorCorrectionLevel: 'L'
        }, err => { if (err) console.error('QR Error:', err); });
      }

      return label;
    }

    function buildPrintLabelsBig(data) {
      const printArea = document.getElementById('printArea');
      printArea.innerHTML = '';

      const container = document.createElement('div');
      container.className = 'container-big';
      printArea.appendChild(container);

      const expanded = [];
      data.forEach(row => {
        const qty = Math.max(1, row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô);
        for (let i = 0; i < qty; i++) {
          expanded.push({ ...row });
        }
      });

      expanded.forEach(row => {
        const sticker = document.createElement('div');
        sticker.className = 'sticker-big';
        const label = createPrintLabelBig(row);
        sticker.appendChild(label);
        container.appendChild(sticker);
      });
    }

    function handlePrintSmall() {
      const data = collectPrintData();
      if (!data.length) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Material ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå');
        return;
      }
      spinner.style.display = 'flex';
      setTimeout(() => {
        buildPrintLabelsSmall(data);
        spinner.style.display = 'none';
        window.print();
      }, 200);
    }

    function handlePrintBig() {
      const data = collectPrintData();
      if (!data.length) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Material ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå');
        return;
      }
      spinner.style.display = 'flex';
      setTimeout(() => {
        buildPrintLabelsBig(data);
        spinner.style.display = 'none';
        window.print();
      }, 200);
    }

    document.getElementById('printSmallBtn').addEventListener('click', handlePrintSmall);
    document.getElementById('printBigBtn').addEventListener('click', handlePrintBig);

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    loadMaterialData();
    loadEmployeeData();
    addNewRow();
  </script>
</body>
</html>
