<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Web App – Material 0301</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 10px;
    }
    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 16px 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .status {
      font-size: 0.85rem;
      margin-top: 6px;
      color: #555;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
    }
    thead {
      background: #007bff;
      color: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      font-size: 0.9rem;
    }
    td input {
      width: 100%;
      box-sizing: border-box;
      border: none;
      padding: 4px 6px;
      font-size: 0.9rem;
    }
    td input[readonly] {
      background: #f0f0f0;
    }
    tr:nth-child(even) td {
      background: #fafafa;
    }
    .not-found {
      color: #c00;
      font-size: 0.8rem;
    }
    #empCodeInput {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 200px;
      margin-left: 4px;
    }
    .employee-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 6px;
      margin-bottom: 4px;
      font-size: 0.95rem;
    }
    .print-btn {
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid #007bff;
  background: #fff;
  cursor: pointer;
  margin-left: 6px;
  font-size: 0.9rem;
  color: #007bff;
}

.print-btn:hover {
  background: #e6f0ff;
}
  </style>
</head>
<body>
  <h1>Web App – Material 0301</h1>

  <!-- ฐานข้อมูล Material -->
  <div class="card">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3>กรอกข้อมูล</h3>

    <!-- ปุ่ม Print -->
    <div>
      <button id="printSmallBtn" class="print-btn">Print Small</button>
      <button id="printBigBtn" class="print-btn">Print Big</button>
    </div>
  </div>
  <!-- ข้อมูลพนักงาน -->
  <div class="card">
    <h3>ข้อมูลผู้ปฏิบัติงาน</h3>
    <div class="employee-row">
      <label>
        รหัสพนักงาน:
        <input id="empCodeInput" type="text" placeholder="กรอกรหัสพนักงาน แล้วกด Enter" />
      </label>
    </div>
    
    <!-- แสดงชื่อ + ทีม แค่ใน empStatus -->
    <div class="status" id="empStatus">กำลังโหลดข้อมูลพนักงาน...</div>
  </div>

  <!-- ตารางกรอกข้อมูล -->
  <div class="card">
    <h3>กรอกข้อมูล</h3>
    <table id="entryTable">
      <thead>
        <tr>
    <th style="width:60px;">ลำดับ</th>
    <th style="width:140px;">Material</th>
    <th>Description</th>
    <th style="width:140px;">Storage bin</th>
    <th style="width:120px;">คงเหลือ</th>
    <th style="width:100px;">จำนวน</th>
    <th style="width:120px;">Pack</th>
  </tr>
      </thead>
      <tbody>
        <!-- แถวจะถูกสร้างด้วย JavaScript -->
      </tbody>
    </table>
    <div class="status" id="rowStatus"></div>
  </div>

  <script>
    // URL ฐานข้อมูล
    const DATA_URL_0301 = 'https://opensheet.elk.sh/1x-B1xekpMm4p7fkKucvLjaewtp66uGIp8ZIxJJZAxMk/Sheet1';
    const EMP_URL      = 'https://opensheet.elk.sh/1eqVoLsZxGguEbRCC5rdI4iMVtQ7CK4T3uXRdx8zE3uw/Employee';

    let materialDB = [];
    let employeeDB = [];
    let nextIndex = 1;

    // element ต่าง ๆ
    const dataStatusEl = document.getElementById('dataStatus');
    const rowStatusEl  = document.getElementById('rowStatus');
    const tableBody    = document.querySelector('#entryTable tbody');

    const empCodeInput = document.getElementById('empCodeInput');
    const empStatus    = document.getElementById('empStatus');

    let employeeCode = '';

    // โหลดฐานข้อมูล Material
    async function loadMaterialData() {
      try {
        const res = await fetch(DATA_URL_0301);
        const data = await res.json();
        materialDB = data;
        dataStatusEl.textContent = `โหลดฐานข้อมูล 0301 สำเร็จ (จำนวน ${materialDB.length} รายการ)`;
      } catch (err) {
        console.error(err);
        dataStatusEl.textContent = 'โหลดฐานข้อมูล 0301 ไม่สำเร็จ กรุณารีหน้าใหม่';
      }
    }

    // โหลดฐานข้อมูล Employee
    async function loadEmployeeData() {
      try {
        const res = await fetch(EMP_URL);
        const data = await res.json();
        employeeDB = data;
        empStatus.textContent = `โหลดข้อมูลพนักงานสำเร็จ (จำนวน ${employeeDB.length} รายการ)`;
      } catch (err) {
        console.error(err);
        empStatus.textContent = 'โหลดข้อมูลพนักงานไม่สำเร็จ กรุณารีหน้าใหม่';
      }
    }

    // แปลงรหัส Material ตามจำนวนตัวอักษร
    function normalizeMaterialCode(raw) {
      if (!raw) return '';
      const trimmed = String(raw).trim();
      const len = trimmed.length;

      if (len === 3) {
        return '30000' + trimmed;
      } else if (len === 4) {
        return '3000' + trimmed;
      } else if (len === 5) {
        return '300' + trimmed;
      }
      return trimmed;
    }

    // หา Material ในฐานข้อมูล
    function findMaterialInfo(materialCode) {
  if (!materialCode) return null;

  const m = materialDB.find(row => {
    const mat = row.Material || row.MATERIAL || row.material || row['Material Code'];
    return mat && String(mat).trim() === String(materialCode).trim();
  });

  if (!m) return null;

  const description =
    m['Material description'] ||
    m['material description'] ||
    m['MATERIAL DESCRIPTION'] ||
    '';

  const storageBin =
    m['Storage bin'] ||
    m['STORAGE BIN'] ||
    m.StorageBin ||
    m['Storage Bin'] ||
    '';

  const unrestricted =
    m['Unrestricted'] ||
    m['unrestricted'] ||
    m['UNRESTRICTED'] ||
    m['Unrestrict'] ||
    '';

  return { description, storageBin, unrestricted };
}

// ปุ่ม Print Small
document.getElementById('printSmallBtn').addEventListener('click', () => {
  alert('Print Small ทำงาน (รอเชื่อมระบบพิมพ์)');
  // TODO: ใส่ฟังก์ชันปริ้นจริงที่นี่
});

// ปุ่ม Print Big
document.getElementById('printBigBtn').addEventListener('click', () => {
  alert('Print Big ทำงาน (รอเชื่อมระบบพิมพ์)');
  // TODO: ใส่ฟังก์ชันปริ้นจริงที่นี่
});
    // หา Employee ตามรหัสพนักงาน (IDRec)
    function findEmployeeById(id) {
      if (!id) return null;
      const trimmed = String(id).trim();

      return employeeDB.find(row => {
        const rec = row.IDRec || row.idrec || row.Id || row.ID;
        return rec && String(rec).trim() === trimmed;
      });
    }

    // ดึงข้อมูล Description / Storage bin ตาม Material ที่กรอก + ตรวจสอบ
    function fillRowByMaterial(tr) {
  const inputs = tr.querySelectorAll('input');

  // ต้องเพิ่ม inputRemain เข้าไปตามลำดับจริงของแถว
  const [inputMat, inputDesc, inputBin, inputRemain, inputQty, inputPack] = inputs;

  let matValue = inputMat.value.trim();
  if (!matValue) {
    rowStatusEl.textContent = 'กรุณากรอก Material';
    return false;
  }

  // แปลงตามกฎ 3/4/5 ตัว
  const normalized = normalizeMaterialCode(matValue);
  inputMat.value = normalized;

  const info = findMaterialInfo(normalized);

  // ถ้าไม่เจอ
  if (!info || !info.description) {
    inputDesc.value = '';
    inputBin.value = '';
    inputRemain.value = '';
    rowStatusEl.innerHTML =
      `<span class="not-found">ไม่พบ Material หรือไม่มี Description: ${normalized} กรุณากรอกใหม่</span>`;
    inputMat.value = '';
    inputMat.focus();
    return false;
  }

  // ถ้าพบ → เติมข้อมูล
  inputDesc.value   = info.description || '';
  inputBin.value    = info.storageBin || '';
  inputRemain.value = info.unrestricted || '';   // ⭐ เพิ่มบรรทัดนี้

  rowStatusEl.textContent = `ดึงข้อมูล Material ${normalized} สำเร็จ`;
  return true;
}

    // สร้างแถวใหม่
    function addNewRow() {
      const tr = document.createElement('tr');

      // ลำดับ
      const tdIndex = document.createElement('td');
      tdIndex.textContent = nextIndex;
      tr.appendChild(tdIndex);

      // Material
      const tdMat = document.createElement('td');
      const inputMat = document.createElement('input');
      inputMat.type = 'text';
      inputMat.placeholder = 'กรอก Material หรือสแกนบาร์โค้ด';
      tdMat.appendChild(inputMat);
      tr.appendChild(tdMat);

      // Description (readonly)
      const tdDesc = document.createElement('td');
      const inputDesc = document.createElement('input');
      inputDesc.type = 'text';
      inputDesc.readOnly = true;
      tdDesc.appendChild(inputDesc);
      tr.appendChild(tdDesc);

      // Storage bin (readonly)
      const tdBin = document.createElement('td');
      const inputBin = document.createElement('input');
      inputBin.type = 'text';
      inputBin.readOnly = true;
      tdBin.appendChild(inputBin);
      tr.appendChild(tdBin);
     // คงเหลือ (Unrestricted)
const tdRemain = document.createElement('td');
const inputRemain = document.createElement('input');
inputRemain.type = 'text';
inputRemain.readOnly = true;
tdRemain.appendChild(inputRemain);
tr.appendChild(tdRemain);

      // จำนวน (default = 1)
      const tdQty = document.createElement('td');
      const inputQty = document.createElement('input');
      inputQty.type = 'number';
      inputQty.min = '1';
      inputQty.placeholder = '1';
      inputQty.value = 1;
      tdQty.appendChild(inputQty);
      tr.appendChild(tdQty);

      // Pack (default = 1)
      const tdPack = document.createElement('td');
      const inputPack = document.createElement('input');
      inputPack.type = 'number';
      inputPack.min = '1';
      inputPack.placeholder = '1';
      inputPack.value = 1;
      tdPack.appendChild(inputPack);
      tr.appendChild(tdPack);

      // Enter ที่ Material = fillRowByMaterial → ถ้าผ่านให้โฟกัสไปที่ช่อง จำนวน
      inputMat.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const ok = fillRowByMaterial(tr);
    if (ok) {
      // ย้ายไปช่อง จำนวน แล้ว select เหมือนกด Ctrl+A
      inputQty.focus();
      inputQty.select();
    }
  }
});

      // Enter ที่ จำนวน = เพิ่มแถวใหม่ + โฟกัส Material แถวใหม่
      inputQty.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          // เช็คว่ามี Material & Description แล้วหรือยัง
          if (!inputMat.value.trim() || !inputDesc.value.trim()) {
            rowStatusEl.textContent = 'กรุณากรอก Material ให้ถูกต้องก่อน';
            inputMat.focus();
            return;
          }
          nextIndex++;
          addNewRow();
        }
      });

      tableBody.appendChild(tr);
      inputMat.focus();
    }

    // Event: กรอกรหัสพนักงานแล้วกด Enter -> ดึง Name + Team และแสดงเป็นข้อความเดียว
    if (empCodeInput) {
      empCodeInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const code = empCodeInput.value.trim();
          employeeCode = code;

          if (!code) {
            empStatus.textContent = 'กรุณากรอกรหัสพนักงาน';
            return;
          }

          const emp = findEmployeeById(code);
          if (!emp) {
            empStatus.innerHTML =
              `<span class="not-found">ไม่พบรหัสพนักงาน: ${code}</span>`;
          } else {
            const name = emp.Name || emp.NAME || emp['Employee Name'] || '';
            const team = emp.Team || emp.TEAM || emp['Team Name'] || '';
            empStatus.textContent =
              `รหัสพนักงาน ${code} : ${name} (${team})`;
          }
        }
      });
    }

    // เริ่มต้น
    loadMaterialData();
    loadEmployeeData();
    addNewRow();
  </script>
</body>
</html>
