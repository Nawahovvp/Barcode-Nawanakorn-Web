<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Web App ‚Äì Material 0301</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap');

    :root {
      --primary: #2563eb;
      --primary-soft: #e0edff;
      --bg: #f3f4f8;
      --card-bg: #ffffff;
      --border-soft: #e2e8f0;
      --text-main: #111827;
      --text-muted: #6b7280;
      --tab-bg: #ffffff;
      --tab-active: #2563eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans Thai', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at top, #e0ebff 0, #f3f4f8 45%, #f9fafb 100%);
      color: var(--text-main);
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
    }

    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    header.app-header .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    header.app-header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    header.app-header .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.08);
      color: var(--primary);
      font-size: 0.75rem;
      font-weight: 600;
      gap: 6px;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.9);
      padding: 4px;
      border-radius: 999px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      border: 1px solid rgba(148, 163, 184, 0.3);
      margin-bottom: 16px;
      width: fit-content;
    }

    .tab-btn {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease;
    }

    .tab-btn span.icon {
      font-size: 1rem;
    }

    .tab-btn.active {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Cards & table (Barcode tab) */
    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 16px 20px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.04);
      border: 1px solid var(--border-soft);
      margin-bottom: 16px;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .status {
      font-size: 0.8rem;
      margin-top: 6px;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(to right, #2563eb, #1d4ed8);
      color: #fff;
    }

    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      font-weight: 600;
      white-space: nowrap;
    }

    td input {
      width: 100%;
      box-sizing: border-box;
      border: none;
      padding: 4px 6px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    td input[readonly] {
      background: #f3f4f6;
      color: #4b5563;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .not-found {
      color: #dc2626;
      font-size: 0.8rem;
    }

    #empCodeInput {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      min-width: 220px;
      margin-left: 4px;
      font-size: 0.9rem;
    }

    #empCodeInput:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
    }

    .employee-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 6px;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .print-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--primary);
      background: #ffffff;
      cursor: pointer;
      margin-left: 6px;
      font-size: 0.9rem;
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.15);
      transition: all 0.18s ease;
    }

    .print-btn:hover {
      background: var(--primary);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25);
    }

    .print-btn .emoji {
      font-size: 1rem;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß Serial */
    .delete-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #ef4444;
      background: #fee2e2;
      color: #b91c1c;
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .delete-btn:hover {
      background: #fecaca;
    }

    /* ========= Serial tab extra UI (Canva-ish) ========= */
    .serial-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-serial-primary {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(to right, #2563eb, #4f46e5);
      color: #ffffff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
    }

    .btn-serial-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.45);
      opacity: 0.95;
    }

    .btn-serial-outline {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #2563eb;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    .btn-serial-outline:hover {
      background: #dbeafe;
      transform: translateY(-1px);
    }

    .serial-summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 6px;
    }

    .serial-chip {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.06);
      border: 1px dashed rgba(37, 99, 235, 0.3);
      font-size: 0.8rem;
      color: #1e3a8a;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .serial-chip-label {
      opacity: 0.7;
    }

    .serial-chip-value {
      font-weight: 600;
    }

    /* ========= ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏â‡∏•‡∏≤‡∏Å Small 102x30 mm ========= */
    #printArea {
      display: none;
    }
    .container-small {
      display: block;
      width: 106mm;
    }
    .sticker-small {
      width: 106mm;
      height: 30mm;
      display: flex;
      flex-direction: row;
      background: white;
      box-sizing: border-box;
      margin-bottom: 0;
    }
    .label-small {
      width: 53mm;
      height: 30mm;
      box-sizing: border-box;
      padding: 1mm;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-right: 0.5px solid #ccc;
    }
    .label-small:last-child {
      border-right: none;
    }
    .row-small {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-bottom: 1mm;
    }
    .qr-small {
      width: 10mm;
      height: 10mm;
      margin-right: 5mm;
      margin-left: 3mm;
    }
    .material-small {
      font-size: 24px;
      font-weight: bold;
      text-align: left;
      margin: 0;
      line-height: 1;
    }
    .technician-small {
      font-size: 10px;
      text-align: left;
      margin: 0;
      margin-right: 2mm;
      line-height: 1;
    }
    .department-small {
      font-size: 10px;
      text-align: left;
      margin: 0;
      margin-right: 2mm;
      line-height: 1;
    }
    .description-small {
      font-size: 10px;
      font-weight: bold;
      text-align: left;
      line-height: 1.2;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      word-wrap: break-word;
      margin: 0;
      margin-left: 2mm;
    }
    .location-small {
      font-size: 12px;
      font-weight: bold;
      text-align: left;
      margin-top: 1px;
      margin-bottom: 0;
      line-height: 1.1;
      margin-left: 2mm;
    }
    .lot-line-small {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 0;
      line-height: 1.1;
      margin-left: 2mm;
      margin-right: 1mm;
    }
    .barcode-small {
      margin-left: 2mm;
      width: 15mm !important;
      height: 6mm !important;
    }

    /* ========= ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏â‡∏•‡∏≤‡∏Å Big 80x100 mm ========= */
    .container-big {
      display: block;
      width: 80mm;
    }
    .sticker-big {
      width: 80mm;
      height: 100mm;
      display: flex;
      flex-direction: column;
      background: white;
      box-sizing: border-box;
      margin-bottom: 0;
      position: relative;
    }
    .label-big {
      width: 80mm;
      height: 100mm;
      box-sizing: border-box;
      padding: 2mm;
      padding-bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 0;
      position: relative;
    }
    .row-big {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      align-items: flex-start;
      margin-bottom: 2mm;
    }
    .bottom-container-big {
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .qr-big {
      width: 14mm;
      height: 14mm;
      margin-right: 2mm;
      margin-left: 3mm;
    }
    .barcode-big {
      width: 20mm !important;
      height: 6mm !important;
      margin-top: 1mm;
      margin-left: 3mm;
    }
    .text-container-big {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 50mm;
    }
    .material-big {
      font-size: 40px;
      font-weight: bold;
      text-align: left;
      margin: 0;
      line-height: 1.1;
    }
    .technician-big {
      font-size: 16px;
      text-align: left;
      margin: 0;
      line-height: 1.3;
    }
    .department-big {
      font-size: 16px;
      text-align: left;
      margin: 0;
      line-height: 1.3;
    }
    .description-big {
      font-size: 20px;
      font-weight: bold;
      text-align: left;
      line-height: 1.3;
      width: calc(100% - 4mm);
      margin: 2mm 0 0 3mm;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      word-wrap: break-word;
    }
    .location-big {
      font-size: 25px;
      font-weight: bold;
      text-align: left;
      margin-top: 0;
      margin-bottom: 0;
      line-height: 1.3;
      margin-left: 3mm;
    }
    .lot-line-big {
      font-size: 20px;
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 0;
      line-height: 1.3;
      margin-left: 3mm;
      margin-right: 2mm;
    }
    .center-pack-unit-big {
      position: absolute;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -30%);
      font-size: 60px;
      font-weight: bold;
      text-align: center;
      width: 80%;
      margin: 0;
      padding: 0;
      line-height: 1;
    }

    /* Spinner */
    .spinner-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    #spinner { display: none; }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media print {
  header.app-header,
  .tabs,
  .print-btn,
  .spinner-container,
  #appRoot {
    display: none !important;
  }
#tab-barcode {
    display: block !important;
  }

  /* ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô tab Serial ‡∏ï‡∏≠‡∏ô print (‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏à‡∏∞‡πÄ‡∏Å‡∏∞‡∏Å‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©) */
  #tab-serial {
    display: none !important;
  }
      #printArea {
        display: block !important;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: 'Noto Sans Thai', sans-serif;
        background: #ffffff;
      }

      .sticker-small,
      .sticker-big {
        page-break-inside: avoid;
        margin: 0;
      }
    }
.container, .sticker, .label {
    page-break-inside: avoid;
  }
  
    .delete-row-btn {
      border: 1px solid #fecaca;
      background: #fee2e2;
      color: #b91c1c;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .delete-row-btn:hover {
      background: #ef4444;
      color: #ffffff;
      border-color: #fca5a5;
    }
    /* ===== Serial Form UI (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Serial Number) ===== */
.serial-form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 8px;
}

.serial-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 160px;
  flex: 1;
}

.serial-field.serial-wide {
  flex: 1.5;
}

.serial-field.serial-narrow {
  max-width: 200px;
}

.serial-label {
  font-size: 0.75rem;
  color: var(--text-muted);
}

.serial-input {
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid #d1d5db;
  font-size: 0.85rem;
  background: #f9fafb;
  transition: all 0.15s ease;
}

.serial-input:focus {
  outline: none;
  border-color: var(--primary);
  background: #ffffff;
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
}

.serial-input[readonly] {
  background: #f3f4f6;
  color: #4b5563;
  font-weight: 500;
}
/* ===== ‡∏â‡∏•‡∏≤‡∏Å Serial 80x100 mm (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô Print Serial) ===== */
.container {
  display: block;
  width: 80mm;
}
.sticker {
  width: 80mm;
  height: 100mm;
  display: flex;
  flex-direction: column;
  background: white;
  box-sizing: border-box;
  margin-bottom: 0;
  position: relative;
}
.label {
  width: 80mm;
  height: 100mm;
  box-sizing: border-box;
  padding: 2mm;
  padding-bottom: 0;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 0;
  position: relative;
}
.row {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  justify-content: space-between;
  flex-wrap: nowrap;
  margin-bottom: 0;   /* ‡πÄ‡∏î‡∏¥‡∏° 0.5mm ‡∏•‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î */
  margin-top: 5mm;
}



/* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢: QR + Barcode ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ö‡∏ô‚Äì‡∏•‡πà‡∏≤‡∏á */
.left-col-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-left: 3mm;
  margin-right: 2mm;
}

/* ‡∏ó‡∏≥ QR ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
.qr {
  width: 12mm;
  height: 12mm;
  margin: 0 0 1mm 0;
}

/* Barcode ‡πÉ‡∏ï‡πâ QR ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á QR */
.barcode-in-text {
  width: 12mm !important;
  height: 6mm !important;
  margin: 0;
  background: white;
}

.text-container {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-width: 50mm;
  align-items: flex-end;   /* ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤ */
  margin-right: 3mm;       /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤ */
  margin-top: 0;
}

.material {
  font-size: 30px;
  font-weight: bold;
  text-align: right;
  margin: 0;
  line-height: 1.0;
}



.barcode-in-text {
  width: 100% !important;
  height: 8mm !important;
  margin-top: 1mm;
  background: white;
}

.description {
  font-size: 20px;
  font-weight: bold;
  text-align: left;
  line-height: 1.3;
  width: calc(100% - 3mm);
  margin: 0 0 0 3mm;   /* üëâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô margin-left ‡πÄ‡∏õ‡πá‡∏ô 3mm, margin-top 0 ‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡πÉ‡∏ï‡πâ row/barcode */
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  word-wrap: break-word;
}
.serial-container {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin: 0 0 0 3mm;   /* üëâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô margin-left ‡πÄ‡∏õ‡πá‡∏ô 3mm, margin-top 0 ‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡πÉ‡∏ï‡πâ description */
  width: calc(100% - 3mm);
}
.serial-info {
  display: flex;
  flex-direction: row;    /* üëâ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
  align-items: baseline;  /* üëâ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏π‡∏á‡πÉ‡∏Å‡∏•‡πâ ‡πÜ ‡∏Å‡∏±‡∏ô */
  gap: 0px;               /* üëâ ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á S/N: ‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç Serial */
  width: 100%;
}

.serial-label {
  font-size: 20px;
  font-weight: bold;
  text-align: left;
  margin: 0;
  line-height: 1.2;
}

.serial-text {
  font-size: 24px;
  font-weight: bold;
  text-align: left;
  margin: 0;
  line-height: 1.2;
}

.firstrear-container {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin: 1mm 0 0 3mm;
  width: calc(100% - 4mm);
}
.firstrear-label {
  font-size: 20px;
  font-weight: bold;
  text-align: left;
  margin: 0;
  line-height: 1.2;
}
.firstrear-text {
  font-size: 20px;
  font-weight: bold;
  text-align: left;
  margin: 0;
  line-height: 1.2;
}
.location {
  font-size: 25px;
  font-weight: bold;
  text-align: left;
  margin-top: 0;
  margin-bottom: 0;
  line-height: 1.3;
  margin-left: 3mm;
}
.lot-line {
  font-size: 25px;
  font-weight: bold;
  margin-top: 0;
  margin-bottom: 0;
  line-height: 1.3;
  margin-left: 3mm;
  margin-right: 2mm;
}
.center-serial-qr {
  position: absolute;
  top: 65%;
  left: 50%;
  transform: translate(-50%, -30%);
  width: 15mm;
  height: 15mm;
  margin-top: 2mm;
}
/* ===== Serial on Big Label (80x100 for Serial) ===== */
.serial-big {
  font-size: 18px;
  font-weight: bold;
  text-align: left;
  line-height: 1.2;
  margin-left: 3mm;
  margin-top: 1mm;
  margin-bottom: 0;
}

.barcode-serial-big {
  width: 30mm !important;
  height: 8mm !important;
  margin-left: 3mm;
  margin-top: 1mm;
}
/* QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Serial ‡∏ö‡∏ô‡∏â‡∏•‡∏≤‡∏Å Big */
.qr-serial-big {
  width: 14mm;
  height: 14mm;
  margin-left: 3mm;
  margin-top: 1mm;
}

/* ‡πÅ‡∏ñ‡∏ß S/N ‡∏ö‡∏ô‡∏â‡∏•‡∏≤‡∏Å Big */
.serial-big {
  font-size: 18px;
  font-weight: bold;
  text-align: left;
  line-height: 1.2;
  margin-left: 3mm;
  margin-top: 1mm;
  margin-bottom: 0;
}
/* ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Description + S/N + QR Serial ‡πÉ‡∏ï‡πâ Barcode 128 */
.info-block-big {
  margin-left: 3mm;
  margin-right: 3mm;
  margin-top: 2mm;
  display: flex;
  flex-direction: column;
  align-items: flex-start;  /* ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
  width: calc(100% - 6mm);  /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© ‡∏•‡∏ö margin ‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
}

/* Description ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏â‡∏•‡∏≤‡∏Å Serial ‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏•‡πá‡∏≠‡∏Å */
.info-block-big .description-big {
  width: 100%;
  margin: 0 0 1mm 0;
  text-align: left;
}

/* ‡πÅ‡∏ñ‡∏ß S/N ‡∏ö‡∏ô‡∏â‡∏•‡∏≤‡∏Å Big */
.serial-big {
  font-size: 18px;
  font-weight: bold;
  text-align: left;
  line-height: 1.2;
  margin: 0 0 1mm 0;
}

/* QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Serial ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ S/N ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
.qr-serial-big {
  width: 20mm;
  height: 20mm;
}

  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="title-block">
        <h1>Smart Warehouse Barcode</h1>
        <div class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏â‡∏•‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏ö‡∏ö Small / Big</div>
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        <span>‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: Barcode</span>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="barcode">
        <span class="icon">üè∑Ô∏è</span>
        <span>Barcode</span>
      </button>
      <button class="tab-btn" data-tab="serial">
        <span class="icon">#Ô∏è‚É£</span>
        <span>Serial Number</span>
      </button>
    </div>

    <!-- Tab: Barcode -->
    <div id="tab-barcode" class="tab-panel active">
      <div id="appRoot">
        <!-- Card: ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á + ‡∏õ‡∏∏‡πà‡∏° Print + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
        <div class="card">
          <div class="card-header-row">
            <div class="card-title">
              <span>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ Barcode</span>
              <span class="card-title-pill">Small & Big Label</span>
            </div>
            <div>
              <button id="printSmallBtn" class="print-btn">
                <span class="emoji">üñ®Ô∏è</span> Print Small
              </button>
              <button id="printBigBtn" class="print-btn">
                <span class="emoji">üñ®Ô∏è</span> Print Big
              </button>
            </div>
          </div>
          <div class="status" id="dataStatus"></div>
        </div>

        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
        <div class="card">
          <div class="card-title">
            ‡∏ú‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô/‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          </div>
          <div class="employee-row">
            <label>
              ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:
              <input id="empCodeInput" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter" />
            </label>
          </div>
          <div class="status" id="empStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</div>
        </div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
        <div class="card">
          <div class="card-title">
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Material
          </div>
          <table id="entryTable">
            <thead>
              <tr>
                <th style="width:50px;">‡∏•‡∏ö</th>
                <th style="width:60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th style="width:140px;">Material</th>
                <th>Description</th>
                <th style="width:140px;">Storage bin</th>
                <th style="width:120px;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                <th style="width:100px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                <th style="width:120px;">Pack</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="status" id="rowStatus"></div>
        </div>
      </div>

      <!-- Spinner -->
      <div class="spinner-container" id="spinner">
        <div class="spinner"></div>
      </div>

      <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å -->
      <div id="printArea"></div>
    </div>

    <!-- Tab: Serial Number -->
    <div id="tab-serial" class="tab-panel">
      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
<div class="card">
  <div class="card-header-row">
    <div class="card-title">
      ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Serial Number
      <span class="card-title-pill">Invoice + Material + Serial</span>
    </div>
    <div class="serial-actions">
      <button id="saveSerialBtn" class="btn-serial-primary">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
      <button id="printSerialBtn" class="btn-serial-outline">
        üñ®Ô∏è Print Serial
      </button>
    </div>
  </div>

  <!-- Summary Chips (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ) -->
  <div class="serial-summary-row">
    <div class="serial-chip" id="serialSummaryInvoice">
      <span class="serial-chip-label">Invoice</span>
      <span class="serial-chip-value">-</span>
    </div>
    <div class="serial-chip" id="serialSummaryMaterial">
      <span class="serial-chip-label">Material</span>
      <span class="serial-chip-value">-</span>
    </div>
    <div class="serial-chip" id="serialSummaryCount">
      <span class="serial-chip-label">Serial</span>
      <span class="serial-chip-value">0 ‡πÅ‡∏ñ‡∏ß</span>
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1: Invoice + Material + Description + Storage bin -->
  <div class="serial-form-row">
    <div class="serial-field serial-narrow">
      <span class="serial-label">Invoice</span>
      <input id="serialInvoiceInput" type="text"
             class="serial-input"
             placeholder="‡∏Å‡∏£‡∏≠‡∏Å Invoice" />
    </div>

    <div class="serial-field serial-narrow">
      <span class="serial-label">Material</span>
      <input id="serialMatInput" type="text"
             class="serial-input"
             placeholder="‡∏Å‡∏£‡∏≠‡∏Å/‡∏™‡πÅ‡∏Å‡∏ô Material" />
    </div>

    <div class="serial-field serial-wide">
      <span class="serial-label">Description</span>
      <input id="serialDescInput" type="text"
             class="serial-input"
             readonly />
    </div>

    <div class="serial-field serial-narrow">
      <span class="serial-label">Storage bin</span>
      <input id="serialBinInput" type="text"
             class="serial-input"
             readonly />
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2: Serial ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ + Serial ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á -->
  <div class="serial-form-row">
    <div class="serial-field serial-narrow">
      <span class="serial-label">Serial ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</span>
      <input id="serialPrefixInput" type="text"
             class="serial-input"
             placeholder="‡πÄ‡∏ä‡πà‡∏ô 0001" />
    </div>

    <div class="serial-field serial-narrow">
      <span class="serial-label">Serial ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á</span>
      <input id="serialSuffixInput" type="text"
             class="serial-input"
             placeholder="‡πÄ‡∏ä‡πà‡∏ô A" />
    </div>
  </div>

  <div class="status" id="serialTopStatus">
    ‡∏Å‡∏£‡∏≠‡∏Å Invoice ‡πÅ‡∏•‡∏∞ Material ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á Description / Storage bin ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  </div>
</div>

      <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Serial -->
      <div class="card">
        <div class="card-title">
          ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Serial Number
        </div>
        <table id="serialTable">
          <thead>
            <tr>
              <th style="width:60px;">‡∏•‡∏ö</th>
              <th style="width:60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th style="width:140px;">Serial</th>
              <th style="width:140px;">Serial ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</th>
              <th style="width:140px;">Serial ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á</th>
              <th style="width:160px;">SerialCP</th>
              <th style="width:120px;">Invoice</th>
              <th style="width:120px;">Material</th>
              <th>Description</th>
              <th style="width:140px;">Storage bin</th>
              <th style="width:160px;">Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="status" id="serialStatus">
          ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏≠‡∏Å Serial ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        </div>
      </div>
    </div>
  </div>

  <!-- QRCode & Barcode libs -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

 <script>
  // ==== ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö ====
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabPanels  = {
    barcode: document.getElementById('tab-barcode'),
    serial:  document.getElementById('tab-serial')
  };

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-tab');

      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      Object.keys(tabPanels).forEach(key => {
        tabPanels[key].classList.toggle('active', key === target);
      });
    });
  });

  const DATA_URL_0301 = 'https://opensheet.elk.sh/1x-B1xekpMm4p7fkKucvLjaewtp66uGIp8ZIxJJZAxMk/Sheet1';
  const EMP_URL       = 'https://opensheet.elk.sh/1eqVoLsZxGguEbRCC5rdI4iMVtQ7CK4T3uXRdx8zE3uw/Employee';

  let materialDB = [];
  let employeeDB = [];
  let nextIndex = 1;

  const dataStatusEl = document.getElementById('dataStatus');
  const rowStatusEl  = document.getElementById('rowStatus');
  const tableBody    = document.querySelector('#entryTable tbody');

  const empCodeInput = document.getElementById('empCodeInput');
  const empStatus    = document.getElementById('empStatus');
  const spinner      = document.getElementById('spinner');

  let employeeCode = '';
  let employeeName = '';
  let employeeTeam = '';

  async function loadMaterialData() {
    try {
      const res = await fetch(DATA_URL_0301);
      const data = await res.json();
      materialDB = data;
      if (dataStatusEl) {
        dataStatusEl.textContent = `‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 0301 ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${materialDB.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
      }
    } catch (err) {
      console.error(err);
      if (dataStatusEl) {
        dataStatusEl.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 0301 ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
      }
    }
  }

  async function loadEmployeeData() {
    try {
      const res = await fetch(EMP_URL);
      const data = await res.json();
      employeeDB = data;
      empStatus.textContent = `‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${employeeDB.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
    } catch (err) {
      console.error(err);
      empStatus.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
    }
  }

  function normalizeMaterialCode(raw) {
    if (!raw) return '';
    const trimmed = String(raw).trim();
    const len = trimmed.length;

    if (len === 3)  return '30000' + trimmed;
    if (len === 4)  return '3000'  + trimmed;
    if (len === 5)  return '300'   + trimmed;
    return trimmed;
  }

  function findMaterialInfo(materialCode) {
    if (!materialCode) return null;

    const m = materialDB.find(row => {
      const mat = row.Material || row.MATERIAL || row.material || row['Material Code'];
      return mat && String(mat).trim() === String(materialCode).trim();
    });

    if (!m) return null;

    const description =
      m['Material description'] ||
      m['material description'] ||
      m['MATERIAL DESCRIPTION'] ||
      '';

    const storageBin =
      m['Storage bin'] ||
      m['STORAGE BIN'] ||
      m.StorageBin ||
      m['Storage Bin'] ||
      '';

    const unrestricted =
      m['Unrestricted'] ||
      m['unrestricted'] ||
      m['UNRESTRICTED'] ||
      m['Unrestrict'] ||
      '';

    return { description, storageBin, unrestricted };
  }

  function findEmployeeById(id) {
    if (!id) return null;
    const trimmed = String(id).trim();

    return employeeDB.find(row => {
      const rec = row.IDRec || row.idrec || row.Id || row.ID;
      return rec && String(rec).trim() === trimmed;
    });
  }

  function fillRowByMaterial(tr) {
    const inputs = tr.querySelectorAll('input');
    const [inputMat, inputDesc, inputBin, inputRemain, inputQty, inputPack] = inputs;

    let matValue = inputMat.value.trim();
    if (!matValue) {
      rowStatusEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Material';
      return false;
    }

    const normalized = normalizeMaterialCode(matValue);
    inputMat.value = normalized;

    const info = findMaterialInfo(normalized);

    if (!info || !info.description) {
      inputDesc.value   = '';
      inputBin.value    = '';
      inputRemain.value = '';
      rowStatusEl.innerHTML =
        `<span class="not-found">‡πÑ‡∏°‡πà‡∏û‡∏ö Material ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ Description: ${normalized} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà</span>`;
      inputMat.value = '';
      inputMat.focus();
      return false;
    }

    inputDesc.value   = info.description || '';
    inputBin.value    = info.storageBin || '';
    inputRemain.value = info.unrestricted || '';

    rowStatusEl.textContent = ''; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
    return true;
  }

  function addNewRow() {
    const tr = document.createElement('tr');

    // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
    const tdDelete = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'delete-row-btn';
    delBtn.textContent = '‡∏•‡∏ö';
    delBtn.addEventListener('click', () => {
      tr.remove();
      updateRowIndices();

      const rows = tableBody.querySelectorAll('tr');
      if (rows.length === 0) {
        nextIndex = 1;
        addNewRow();
      }
    });
    tdDelete.appendChild(delBtn);
    tr.appendChild(tdDelete);

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö
    const tdIndex = document.createElement('td');
    tdIndex.className = 'index-cell';
    tdIndex.textContent = nextIndex;
    tr.appendChild(tdIndex);

    // Material
    const tdMat = document.createElement('td');
    const inputMat = document.createElement('input');
    inputMat.type = 'text';
    inputMat.placeholder = '‡∏Å‡∏£‡∏≠‡∏Å Material ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î';
    tdMat.appendChild(inputMat);
    tr.appendChild(tdMat);

    // Description
    const tdDesc = document.createElement('td');
    const inputDesc = document.createElement('input');
    inputDesc.type = 'text';
    inputDesc.readOnly = true;
    tdDesc.appendChild(inputDesc);
    tr.appendChild(tdDesc);

    // Storage bin
    const tdBin = document.createElement('td');
    const inputBin = document.createElement('input');
    inputBin.type = 'text';
    inputBin.readOnly = true;
    tdBin.appendChild(inputBin);
    tr.appendChild(tdBin);

    // ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
    const tdRemain = document.createElement('td');
    const inputRemain = document.createElement('input');
    inputRemain.type = 'text';
    inputRemain.readOnly = true;
    tdRemain.appendChild(inputRemain);
    tr.appendChild(tdRemain);

    // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
    const tdQty = document.createElement('td');
    const inputQty = document.createElement('input');
    inputQty.type = 'number';
    inputQty.min = '1';
    inputQty.placeholder = '1';
    inputQty.value = 1;
    tdQty.appendChild(inputQty);
    tr.appendChild(tdQty);

    // Pack
    const tdPack = document.createElement('td');
    const inputPack = document.createElement('input');
    inputPack.type = 'number';
    inputPack.min = '1';
    inputPack.placeholder = '1';
    inputPack.value = 1;
    tdPack.appendChild(inputPack);
    tr.appendChild(tdPack);

    inputMat.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const ok = fillRowByMaterial(tr);
        if (ok) {
          inputQty.focus();
          inputQty.select();
        }
      }
    });

    inputQty.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (!inputMat.value.trim() || !inputDesc.value.trim()) {
          rowStatusEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Material ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô';
          inputMat.focus();
          return;
        }
        nextIndex++;
        addNewRow();
        updateRowIndices();
      }
    });

    tableBody.appendChild(tr);
    inputMat.focus();
  }

  if (empCodeInput) {
    empCodeInput.addEventListener('input', () => {
      const code = empCodeInput.value.trim();
      employeeCode = code;

      if (!code) {
        empStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
        employeeName = '';
        employeeTeam = '';
        return;
      }

      const emp = findEmployeeById(code);
      if (!emp) {
        empStatus.innerHTML =
          `<span class="not-found">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${code}</span>`;
        employeeName = '';
        employeeTeam = '';
        return;
      }

      const name = emp.Name || emp.NAME || emp['Employee Name'] || '';
      const team = emp.Team || emp.TEAM || emp['Team Name'] || '';
      employeeName = name;
      employeeTeam = team;
      empStatus.textContent =
        `‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${code} : ${name} (${team})`;

      const firstMat = document.querySelector('#entryTable tbody tr:first-child input');
      if (firstMat) {
        firstMat.focus();
        firstMat.select();
      }
    });
  }

  function updateRowIndices() {
    const rows = tableBody.querySelectorAll('tr');
    let idx = 1;
    rows.forEach(tr => {
      const indexCell = tr.querySelector('td.index-cell');
      if (indexCell) {
        indexCell.textContent = idx++;
      }
    });
    nextIndex = idx;
  }

  function collectPrintData() {
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    const data = [];

    rows.forEach(tr => {
      const inputs = tr.querySelectorAll('input');
      if (inputs.length < 6) return;

      const [inputMat, inputDesc, inputBin, inputRemain, inputQty, inputPack] = inputs;
      const material = inputMat.value.trim();
      if (!material) return;

      const qty = parseInt(inputQty.value, 10) || 1;

      data.push({
        Material:   material,
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:      qty,
        Pack:       inputPack.value || '',
        ID‡∏ä‡πà‡∏≤‡∏á:     employeeCode || '',
        Serial:     '-',
        Description:inputDesc.value || '',
        Storagebin: inputBin.value || '',
        ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á:   employeeName || '',
        Unit:       'pc',
        ‡πÅ‡∏ú‡∏ô‡∏Å:       employeeTeam || ''
      });
    });

    return data;
  }

  // Small label
  function createPrintLabelSmall(row) {
    const label = document.createElement('div');
    label.className = 'label-small';

    const rowDiv = document.createElement('div');
    rowDiv.className = 'row-small';

    const qrCanvas = document.createElement('canvas');
    qrCanvas.className = 'qr-small';
    rowDiv.appendChild(qrCanvas);

    const textContainer = document.createElement('div');
    textContainer.style.display = 'flex';
    textContainer.style.flexDirection = 'column';

    const materialDiv = document.createElement('div');
    materialDiv.className = 'material-small';
    materialDiv.textContent = row.Material;
    textContainer.appendChild(materialDiv);

    const techNameRaw = row.‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á || '';
    const technicianName = techNameRaw.replace(/^‡∏ô‡∏≤‡∏¢\s+/, '').trim();
    if (technicianName) {
      const technicianDiv = document.createElement('div');
      technicianDiv.className = 'technician-small';
      technicianDiv.textContent = technicianName;
      textContainer.appendChild(technicianDiv);
    }

    const dept = (row.‡πÅ‡∏ú‡∏ô‡∏Å || '').trim();
    if (dept) {
      const departmentDiv = document.createElement('div');
      departmentDiv.className = 'department-small';
      departmentDiv.textContent = dept;
      textContainer.appendChild(departmentDiv);
    }

    rowDiv.appendChild(textContainer);
    label.appendChild(rowDiv);

    const descText = (row.Description || '').trim();
    if (descText) {
      const desc = document.createElement('div');
      desc.className = 'description-small';
      desc.textContent = descText;
      label.appendChild(desc);
    }

    const locLine = document.createElement('div');
    locLine.style.display = 'flex';
    locLine.style.alignItems = 'center';
    locLine.style.fontSize = '12px';
    locLine.style.fontWeight = 'bold';
    locLine.style.lineHeight = '1.1';
    locLine.style.marginLeft = '2mm';
    locLine.style.marginTop = '1px';
    locLine.style.marginBottom = '0';

    const locTextStr = (row.Storagebin || '').trim();
    if (locTextStr) {
      const locText = document.createElement('span');
      locText.textContent = `Loc: ${locTextStr}`;
      locLine.appendChild(locText);
    }

    const barcodeCanvas = document.createElement('canvas');
    barcodeCanvas.className = 'barcode-small';
    locLine.appendChild(barcodeCanvas);
    label.appendChild(locLine);

    const now = new Date();
    const formattedDate =
      `${now.getFullYear().toString().slice(2)}` +
      `${String(now.getMonth() + 1).padStart(2, '0')}` +
      `${String(now.getDate()).padStart(2, '0')}` +
      `${String(now.getHours()).padStart(2, '0')}` +
      `${String(now.getMinutes()).padStart(2, '0')}`;

    const lot = document.createElement('div');
    lot.className = 'lot-line-small';

    const parts = [];
    parts.push(`Lot: ${formattedDate}`);
    const qtyText  = row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ? `(${row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô})` : '';
    if (qtyText) parts.push(qtyText);
    const packText = (row.Pack || '').trim();
    if (packText) parts.push(packText);
    const unitText = (row.Unit || '').trim();
    if (unitText) parts.push(unitText);

    lot.innerHTML = `<span>${parts.join(' ')}</span>`;
    label.appendChild(lot);

    if (typeof QRCode !== 'undefined') {
      QRCode.toCanvas(qrCanvas, row.Material || 'N/A', {
        width: 40,
        height: 40,
        margin: 0,
        errorCorrectionLevel: 'L'
      }, err => { if (err) console.error('QR Error:', err); });
    }

    if (typeof JsBarcode !== 'undefined' && row.Material) {
      JsBarcode(barcodeCanvas, row.Material, {
        format: 'CODE128',
        width: 1,
        height: 15,
        displayValue: false,
        margin: 0
      });
    }

    return label;
  }

  function buildPrintLabelsSmall(data) {
    const printArea = document.getElementById('printArea');
    printArea.innerHTML = '';

    const container = document.createElement('div');
    container.className = 'container-small';
    printArea.appendChild(container);

    const expanded = [];
    data.forEach(row => {
      const qty = Math.max(1, row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô);
      for (let i = 0; i < qty; i++) {
        expanded.push({ ...row });
      }
    });

    for (let i = 0; i < expanded.length; i += 2) {
      const sticker = document.createElement('div');
      sticker.className = 'sticker-small';

      const label1 = createPrintLabelSmall(expanded[i]);
      sticker.appendChild(label1);

      if (i + 1 < expanded.length) {
        const label2 = createPrintLabelSmall(expanded[i + 1]);
        sticker.appendChild(label2);
      } else {
        const emptyLabel = document.createElement('div');
        emptyLabel.className = 'label-small';
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'description-small';
        emptyDiv.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        emptyLabel.appendChild(emptyDiv);
        sticker.appendChild(emptyLabel);
      }

      container.appendChild(sticker);
    }
  }

  // Big label (barcode tab)
  function createPrintLabelBig(row) {
    const label = document.createElement('div');
    label.className = 'label-big';

    const rowDiv = document.createElement('div');
    rowDiv.className = 'row-big';

    const leftCol = document.createElement('div');
    leftCol.style.display = 'flex';
    leftCol.style.flexDirection = 'column';
    leftCol.style.alignItems = 'flex-start';

    const qrCanvas = document.createElement('canvas');
    qrCanvas.className = 'qr-big';
    leftCol.appendChild(qrCanvas);

    const barcodeCanvas = document.createElement('canvas');
    barcodeCanvas.className = 'barcode-big';
    leftCol.appendChild(barcodeCanvas);

    rowDiv.appendChild(leftCol);

    const textContainer = document.createElement('div');
    textContainer.className = 'text-container-big';

    const materialDiv = document.createElement('div');
    materialDiv.className = 'material-big';
    materialDiv.textContent = row.Material;
    textContainer.appendChild(materialDiv);

    const techNameRaw = row.‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á || '';
    const technicianName = techNameRaw.replace(/^‡∏ô‡∏≤‡∏¢\s+/, '').trim();
    if (technicianName) {
      const technicianDiv = document.createElement('div');
      technicianDiv.className = 'technician-big';
      technicianDiv.textContent = technicianName;
      textContainer.appendChild(technicianDiv);
    }

    const dept = (row.‡πÅ‡∏ú‡∏ô‡∏Å || '').trim();
    if (dept) {
      const departmentDiv = document.createElement('div');
      departmentDiv.className = 'department-big';
      departmentDiv.textContent = dept;
      textContainer.appendChild(departmentDiv);
    }

    rowDiv.appendChild(textContainer);

    const descText = (row.Description || '').trim();
    if (descText) {
      const desc = document.createElement('div');
      desc.className = 'description-big';
      desc.textContent = descText;
      rowDiv.appendChild(desc);
    }

    label.appendChild(rowDiv);

    const bottomContainer = document.createElement('div');
    bottomContainer.className = 'bottom-container-big';

    const now = new Date();
    const formattedDate =
      `${now.getFullYear().toString().slice(2)}` +
      `${String(now.getMonth() + 1).padStart(2, '0')}` +
      `${String(now.getDate()).padStart(2, '0')}` +
      `${String(now.getHours()).padStart(2, '0')}` +
      `${String(now.getMinutes()).padStart(2, '0')}`;

    const locTextStr = (row.Storagebin || '').trim();
    if (locTextStr) {
      const loc = document.createElement('div');
      loc.className = 'location-big';
      loc.textContent = `Location: ${locTextStr}`;
      bottomContainer.appendChild(loc);
    }

    const lot = document.createElement('div');
    lot.className = 'lot-line-big';
    lot.textContent = `Lot: ${formattedDate} Qty(${row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô || 1})`;
    bottomContainer.appendChild(lot);

    label.appendChild(bottomContainer);

    const centerPackUnit = document.createElement('div');
    centerPackUnit.className = 'center-pack-unit-big';
    const packText = (row.Pack || '').trim();
    const unitText = (row.Unit || '').trim();
    centerPackUnit.textContent = `${packText} ${unitText}`.trim();
    label.appendChild(centerPackUnit);

    if (typeof QRCode !== 'undefined') {
      QRCode.toCanvas(qrCanvas, row.Material || 'N/A', {
        width: 55,
        height: 55,
        margin: 0,
        errorCorrectionLevel: 'L'
      }, err => { if (err) console.error('QR Error:', err); });
    }

    if (typeof JsBarcode !== 'undefined' && row.Material) {
      JsBarcode(barcodeCanvas, row.Material, {
        format: 'CODE128',
        width: 1,
        height: 25,
        displayValue: false,
        margin: 0
      });
    }

    return label;
  }

  function buildPrintLabelsBig(data) {
    const printArea = document.getElementById('printArea');
    printArea.innerHTML = '';

    const container = document.createElement('div');
    container.className = 'container-big';
    printArea.appendChild(container);

    const expanded = [];
    data.forEach(row => {
      const qty = Math.max(1, row.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô);
      for (let i = 0; i < qty; i++) {
        expanded.push({ ...row });
      }
    });

    expanded.forEach(row => {
      const sticker = document.createElement('div');
      sticker.className = 'sticker-big';
      const label = createPrintLabelBig(row);
      sticker.appendChild(label);
      container.appendChild(sticker);
    });
  }

  function handlePrintSmall() {
    const data = collectPrintData();
    if (!data.length) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Material ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå');
      return;
    }
    spinner.style.display = 'flex';
    setTimeout(() => {
      buildPrintLabelsSmall(data);
      spinner.style.display = 'none';
      window.print();
    }, 200);
  }

  function handlePrintBig() {
    const data = collectPrintData();
    if (!data.length) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Material ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå');
      return;
    }
    spinner.style.display = 'flex';
    setTimeout(() => {
      buildPrintLabelsBig(data);
      spinner.style.display = 'none';
      window.print();
    }, 200);
  }
  

  document.getElementById('printSmallBtn').addEventListener('click', handlePrintSmall);
  document.getElementById('printBigBtn').addEventListener('click', handlePrintBig);

  // ====== ‡∏™‡πà‡∏ß‡∏ô Serial Tab ======
  const serialInvoiceInput = document.getElementById('serialInvoiceInput');
  const serialMatInput     = document.getElementById('serialMatInput');
  const serialDescInput    = document.getElementById('serialDescInput');
  const serialBinInput     = document.getElementById('serialBinInput');
  const serialPrefixInput  = document.getElementById('serialPrefixInput');
  const serialSuffixInput  = document.getElementById('serialSuffixInput');
  const serialTopStatus    = document.getElementById('serialTopStatus');
  const serialTableBody    = document.querySelector('#serialTable tbody');
  const serialStatusEl     = document.getElementById('serialStatus');
  const serialSummaryInvoice = document.getElementById('serialSummaryInvoice');
  const serialSummaryMaterial = document.getElementById('serialSummaryMaterial');
  const serialSummaryCount = document.getElementById('serialSummaryCount');
  const saveSerialBtn      = document.getElementById('saveSerialBtn');
  const printSerialBtn     = document.getElementById('printSerialBtn');
  let serialNextIndex      = 1;

  function getNowString() {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const hh = String(now.getHours()).padStart(2, '0');
    const mi = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï summary chips
  function updateSerialSummary() {
    if (serialSummaryInvoice) {
      const v = serialInvoiceInput.value.trim() || '-';
      serialSummaryInvoice.querySelector('.serial-chip-value').textContent = v;
    }
    if (serialSummaryMaterial) {
      const v = serialMatInput.value.trim() || '-';
      serialSummaryMaterial.querySelector('.serial-chip-value').textContent = v;
    }
    if (serialSummaryCount) {
      const count = serialTableBody.querySelectorAll('tr').length;
      serialSummaryCount.querySelector('.serial-chip-value').textContent = `${count} ‡πÅ‡∏ñ‡∏ß`;
    }
  }

  // ‡πÉ‡∏´‡πâ Invoice ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï chip ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (serialInvoiceInput) {
    serialInvoiceInput.addEventListener('input', updateSerialSummary);
  }

  // ‡∏î‡∏∂‡∏á Description / Storage bin ‡∏à‡∏≤‡∏Å Material ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Serial tab
  function fillSerialTopByMaterial() {
    let mat = serialMatInput.value.trim();
    if (!mat) {
      serialDescInput.value = '';
      serialBinInput.value  = '';
      serialTopStatus.textContent = '‡∏Å‡∏£‡∏≠‡∏Å Material ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á Description / Storage bin ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      updateSerialSummary();
      return;
    }

    const normalized = normalizeMaterialCode(mat);
    serialMatInput.value = normalized;

    const info = findMaterialInfo(normalized);
    if (!info || !info.description) {
      serialDescInput.value = '';
      serialBinInput.value  = '';
      serialTopStatus.innerHTML =
        `<span class="not-found">‡πÑ‡∏°‡πà‡∏û‡∏ö Material ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ Description: ${normalized}</span>`;
      updateSerialSummary();
      return;
    }

    serialDescInput.value = info.description || '';
    serialBinInput.value  = info.storageBin || '';
    serialTopStatus.textContent = '';
    updateSerialSummary();
  }

  // ‡πÉ‡∏´‡πâ Material ‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
  let serialMatTimer = null;

  if (serialMatInput) {
    serialMatInput.addEventListener('input', () => {
      if (serialMatTimer) clearTimeout(serialMatTimer);
      serialMatTimer = setTimeout(() => {
        fillSerialTopByMaterial();
      }, 400);
    });

    serialMatInput.addEventListener('blur', () => {
      fillSerialTopByMaterial();
    });
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß Serial ‡πÉ‡∏´‡∏°‡πà
   // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß Serial ‡πÉ‡∏´‡∏°‡πà
  function addSerialRow() {
    const tr = document.createElement('tr');

    // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
    const tdDelete = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.textContent = '‡∏•‡∏ö';
    delBtn.className = 'delete-btn';
    delBtn.addEventListener('click', () => {
      tr.remove();
      reindexSerialRows();
    });
    tdDelete.appendChild(delBtn);
    tr.appendChild(tdDelete);

    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö
    const tdIndex = document.createElement('td');
    tdIndex.textContent = serialNextIndex;
    tr.appendChild(tdIndex);

    // Serial
    const tdSerial = document.createElement('td');
    const inputSerial = document.createElement('input');
    inputSerial.type = 'text';
    inputSerial.placeholder = '‡∏Å‡∏£‡∏≠‡∏Å Serial ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter';
    tdSerial.appendChild(inputSerial);
    tr.appendChild(tdSerial);

    // Serial ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤
    const tdPrefix = document.createElement('td');
    const inputPrefix = document.createElement('input');
    inputPrefix.type = 'text';
    inputPrefix.readOnly = true;
    inputPrefix.value = serialPrefixInput.value || '';
    tdPrefix.appendChild(inputPrefix);
    tr.appendChild(tdPrefix);

    // Serial ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á
    const tdSuffix = document.createElement('td');
    const inputSuffix = document.createElement('input');
    inputSuffix.type = 'text';
    inputSuffix.readOnly = true;
    inputSuffix.value = serialSuffixInput.value || '';
    tdSuffix.appendChild(inputSuffix);
    tr.appendChild(tdSuffix);

    // SerialCP
    const tdSerialCP = document.createElement('td');
    const inputSerialCP = document.createElement('input');
    inputSerialCP.type = 'text';
    inputSerialCP.readOnly = true;
    tdSerialCP.appendChild(inputSerialCP);
    tr.appendChild(tdSerialCP);

    // Invoice
    const tdInvoice = document.createElement('td');
    const inputInvoice = document.createElement('input');
    inputInvoice.type = 'text';
    inputInvoice.readOnly = true;
    inputInvoice.value = serialInvoiceInput.value || '';
    tdInvoice.appendChild(inputInvoice);
    tr.appendChild(tdInvoice);

    // Material
    const tdMat = document.createElement('td');
    const inputMat = document.createElement('input');
    inputMat.type = 'text';
    inputMat.readOnly = true;
    inputMat.value = serialMatInput.value || '';
    tdMat.appendChild(inputMat);
    tr.appendChild(tdMat);

    // Description
    const tdDesc = document.createElement('td');
    const inputDesc = document.createElement('input');
    inputDesc.type = 'text';
    inputDesc.readOnly = true;
    inputDesc.value = serialDescInput.value || '';
    tdDesc.appendChild(inputDesc);
    tr.appendChild(tdDesc);

    // Storage bin
    const tdBin = document.createElement('td');
    const inputBin = document.createElement('input');
    inputBin.type = 'text';
    inputBin.readOnly = true;
    inputBin.value = serialBinInput.value || '';
    tdBin.appendChild(inputBin);
    tr.appendChild(tdBin);

    // Date
    const tdDate = document.createElement('td');
    const inputDate = document.createElement('input');
    inputDate.type = 'text';
    inputDate.readOnly = true;
    inputDate.value = getNowString();
    tdDate.appendChild(inputDate);
    tr.appendChild(tdDate);

    // ---------- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ó‡∏≥ Enter + ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å (blur) ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô ----------
    let committed = false;   // ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏™‡∏≠‡∏á‡∏£‡∏≠‡∏ö (‡∏ï‡∏≠‡∏ô Enter ‡πÅ‡∏•‡πâ‡∏ß blur ‡∏ï‡∏≤‡∏°‡∏°‡∏≤)

    function commitSerialRow() {
      if (committed) return;      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏µ‡∏Å
      const serialVal = inputSerial.value.trim();

      if (!serialVal) {
        serialStatusEl.innerHTML =
          '<span class="not-found">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤ Serial ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á</span>';
        return;
      }

      committed = true;

      // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ
      inputPrefix.value  = serialPrefixInput.value || '';
      inputSuffix.value  = serialSuffixInput.value || '';
      inputInvoice.value = serialInvoiceInput.value || '';
      inputMat.value     = serialMatInput.value || '';
      inputDesc.value    = serialDescInput.value || '';
      inputBin.value     = serialBinInput.value || '';
      inputDate.value    = getNowString();

      // SerialCP = prefix + serial + suffix
      inputSerialCP.value =
        (inputPrefix.value || '') + serialVal + (inputSuffix.value || '');

      serialStatusEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Serial ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß';
      serialNextIndex++;
      addSerialRow();
      updateSerialSummary();
    }

    // ‡∏Å‡∏î Enter ‚Üí ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    inputSerial.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        commitSerialRow();
      }
    });

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á ‚Üí ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Enter
    inputSerial.addEventListener('blur', () => {
      if (!inputSerial.value.trim()) return; // ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
      commitSerialRow();
    });

    // ------------------------------------------------------

    serialTableBody.appendChild(tr);
    inputSerial.focus();
    updateSerialSummary();
  }

  function reindexSerialRows() {
    const rows = serialTableBody.querySelectorAll('tr');
    let idx = 1;
    rows.forEach(tr => {
      const indexTd = tr.children[1];
      indexTd.textContent = idx++;
    });
    serialNextIndex = idx;

    if (!rows.length) {
      serialNextIndex = 1;
      serialStatusEl.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
      addSerialRow();
    }
    updateSerialSummary();
  }

 
// ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Serial ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏•‡∏≤‡∏Å 80x100 mm ‡πÅ‡∏ö‡∏ö Big
function collectSerialPrintData() {
  const rows = Array.from(serialTableBody.querySelectorAll('tr'));
  const data = [];

  rows.forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    // 9 ‡∏ä‡πà‡∏≠‡∏á: Serial, Prefix, Suffix, SerialCP, Invoice, Material, Desc, Bin, Date
    if (inputs.length < 9) return;

    const [
      inputSerial,    // Serial (‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á)
      inputPrefix,    // Serial ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤
      inputSuffix,    // Serial ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á
      inputSerialCP,  // SerialCP (prefix + serial + suffix)
      inputInvoice,
      inputMat,
      inputDesc,
      inputBin,
      inputDate
    ] = inputs;

    const material = inputMat.value.trim();
    const serialCP = inputSerialCP.value.trim();
    const desc = inputDesc.value || '';
    const bin = inputBin.value || '';

    if (!material || !serialCP) return; // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á Material ‡πÅ‡∏•‡∏∞ SerialCP

    data.push({
      Material: material,
      Serial: serialCP,       // ‡πÉ‡∏ä‡πâ SerialCP ‡πÄ‡∏õ‡πá‡∏ô Serial ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏â‡∏•‡∏≤‡∏Å
      Description: desc,
      Storagebin: bin
    });
  });

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Material ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏° Serial
  data.sort((a, b) => {
    const m = a.Material.localeCompare(b.Material);
    if (m !== 0) return m;
    return a.Serial.localeCompare(b.Serial);
  });

  return data;
}

// Layout: ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô QR + Barcode Material, ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏õ‡πá‡∏ô Description + S/N + QR Serial
function createLabel(row) {
  const label = document.createElement('div');
  label.className = 'label-big';   // ‡πÉ‡∏ä‡πâ‡∏™‡πÑ‡∏ï‡∏•‡πå Big ‡πÄ‡∏î‡∏¥‡∏° (80x100 mm)

  // ===== ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: QR + Barcode (Material) + Material text =====
  const rowDiv = document.createElement('div');
  rowDiv.className = 'row-big';

  // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢: QR + Barcode Material
  const leftCol = document.createElement('div');
  leftCol.style.display = 'flex';
  leftCol.style.flexDirection = 'column';
  leftCol.style.alignItems = 'flex-start';

  const qrCanvasMat = document.createElement('canvas');
  qrCanvasMat.className = 'qr-big';
  leftCol.appendChild(qrCanvasMat);

  const barcodeMatCanvas = document.createElement('canvas');
  barcodeMatCanvas.className = 'barcode-big';
  leftCol.appendChild(barcodeMatCanvas);

  rowDiv.appendChild(leftCol);

  // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ß‡∏≤: ‡πÅ‡∏™‡∏î‡∏á Material ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà
  const textRight = document.createElement('div');
  textRight.className = 'text-container-big';

  const materialDiv = document.createElement('div');
  materialDiv.className = 'material-big';
  materialDiv.textContent = row.Material;
  textRight.appendChild(materialDiv);

  rowDiv.appendChild(textRight);
  label.appendChild(rowDiv);

  // ===== ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©: Description + S/N + QR Serial =====
  const infoBlock = document.createElement('div');
  infoBlock.className = 'info-block-big';

  // Description ‡πÉ‡∏ï‡πâ Barcode128 ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢
 // Description ‡πÉ‡∏ï‡πâ Barcode128 ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢
const descText = (row.Description || '').trim();
if (descText) {
  const descDiv = document.createElement('div');
  descDiv.className = 'description-big';
  descDiv.textContent = descText;
  descDiv.style.marginTop = '1mm'; // ‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á
  infoBlock.appendChild(descDiv);
}


  // S/N: xxxx
  if (row.Serial) {
    const serialDiv = document.createElement('div');
    serialDiv.className = 'serial-big';
    serialDiv.textContent = `S/N: ${row.Serial}`;
    infoBlock.appendChild(serialDiv);

    // QR Code Serial ‡πÉ‡∏ï‡πâ S/N ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢
    const qrSerialCanvas = document.createElement('canvas');
    qrSerialCanvas.className = 'qr-serial-big';
    infoBlock.appendChild(qrSerialCanvas);

    if (typeof QRCode !== 'undefined') {
      QRCode.toCanvas(qrSerialCanvas, row.Serial || 'N/A', {
        width: 40,
        height: 40,
        margin: 0,
        errorCorrectionLevel: 'L'
      }, err => {
        if (err) console.error('QR Error for Serial:', err);
      });
    }
  }

  label.appendChild(infoBlock);

  // ===== ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î: Location + Lot (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Print Big ‡πÄ‡∏î‡∏¥‡∏°) =====
  const bottomContainer = document.createElement('div');
  bottomContainer.className = 'bottom-container-big';

  const now = new Date();
  const formattedDate =
    `${now.getFullYear().toString().slice(2)}` +
    `${String(now.getMonth() + 1).padStart(2, '0')}` +
    `${String(now.getDate()).padStart(2, '0')}` +
    `${String(now.getHours()).padStart(2, '0')}` +
    `${String(now.getMinutes()).padStart(2, '0')}`;

  const locTextStr = (row.Storagebin || '').trim();
  if (locTextStr) {
    const loc = document.createElement('div');
    loc.className = 'location-big';
    loc.textContent = `Location: ${locTextStr}`;
    bottomContainer.appendChild(loc);
  }

  const lot = document.createElement('div');
  lot.className = 'lot-line-big';
  lot.textContent = `Lot: ${formattedDate}`;
  bottomContainer.appendChild(lot);

  label.appendChild(bottomContainer);

  // ===== Generate QR + Barcode Material (‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô) =====
  if (typeof QRCode !== 'undefined') {
    QRCode.toCanvas(qrCanvasMat, row.Material || 'N/A', {
      width: 55,
      height: 55,
      margin: 0,
      errorCorrectionLevel: 'L'
    }, err => {
      if (err) console.error('QR Error for Material:', err);
    });
  }

  if (typeof JsBarcode !== 'undefined') {
    JsBarcode(barcodeMatCanvas, row.Material || '00000000', {
      format: 'CODE128',
      width: 1,
      height: 25,
      displayValue: false,
      margin: 0
    });
  }

  return label;
}

 // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á DOM ‡∏â‡∏•‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÉ‡∏ô #printArea
// ‚úÖ ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡∏£‡∏á container-big / sticker-big ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Print Big
function buildSerialLabelsForPrint(data) {
  const printArea = document.getElementById('printArea');
  printArea.innerHTML = '';

  const container = document.createElement('div');
  container.className = 'container-big';
  printArea.appendChild(container);

  if (!data.length) {
    container.innerHTML = '<p style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Print</p>';
    return;
  }

  data.forEach(row => {
    const sticker = document.createElement('div');
    sticker.className = 'sticker-big';

    const label = createLabel(row); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    sticker.appendChild(label);

    container.appendChild(sticker);
  });
}


  // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Serial (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
  if (saveSerialBtn) {
    saveSerialBtn.addEventListener('click', () => {
      const rowCount = serialTableBody.querySelectorAll('tr').length;
      if (!rowCount) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Serial ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
      }
      alert('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö');
    });
  }

  // ‡∏õ‡∏∏‡πà‡∏° Print Serial => ‡πÉ‡∏ä‡πâ layout 80x100 ‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
 if (printSerialBtn) {
  printSerialBtn.addEventListener('click', () => {
    const data = collectSerialPrintData();
    if (!data.length) {
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Serial ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå');
      return;
    }

    spinner.style.display = 'flex';

    setTimeout(() => {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏•‡∏≤‡∏Å Serial ‡πÅ‡∏ö‡∏ö Big
      buildSerialLabelsForPrint(data);

      // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ QR / Barcode ‡∏ß‡∏≤‡∏î‡∏•‡∏á canvas ‡πÄ‡∏™‡∏£‡πá‡∏à
      setTimeout(() => {
        spinner.style.display = 'none';
        window.print();
      }, 300);
    }, 200);
  });
}



  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  loadMaterialData();
  loadEmployeeData();
  addNewRow();        // barcode tab
  addSerialRow();     // serial tab ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
  updateSerialSummary();
</script>

</body>
</html>
